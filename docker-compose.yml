services:
  traefik:
    image: traefik:v2.11
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=${DOCKER_NETWORK:-clawhuddle-net}"
      - "--entrypoints.web.address=:80"
    ports:
      - "8080:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - clawhuddle-net
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    environment:
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - AUTH_TRUST_HOST=true
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - API_URL=http://api:4000
      - ALLOWED_DOMAIN=${ALLOWED_DOMAIN:-}
      - NEXT_PUBLIC_GATEWAY_DOMAIN=${GATEWAY_DOMAIN:-}
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.web.loadbalancer.server.port=3000"
      # NextAuth routes â€” highest priority
      - "traefik.http.routers.web-auth.rule=PathPrefix(`/api/auth`)"
      - "traefik.http.routers.web-auth.priority=30"
      - "traefik.http.routers.web-auth.entrypoints=web"
      - "traefik.http.routers.web-auth.service=web"
      # Catch-all for frontend
      - "traefik.http.routers.web.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.web.priority=1"
      - "traefik.http.routers.web.entrypoints=web"
      - "traefik.http.routers.web.service=web"
    depends_on:
      - api
    networks:
      - clawhuddle-net
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    environment:
      - DATABASE_PATH=/data/db.sqlite
      - DATA_DIR=/data
      - HOST_DATA_DIR=${HOST_DATA_DIR:-${PWD}/data}
      - PORT=4000
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM:-}
      - APP_URL=${APP_URL:-http://localhost:3000}
      - SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL:-}
      - DOCKER_NETWORK=clawhuddle-net
      - DOMAIN=${DOMAIN:-localhost}
      - GATEWAY_DOMAIN=${GATEWAY_DOMAIN:-}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=PathPrefix(`/api`) && !PathPrefix(`/api/auth`)"
      - "traefik.http.routers.api.priority=20"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.services.api.loadbalancer.server.port=4000"
    volumes:
      - ./data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      gateway-base:
        condition: service_completed_successfully
    networks:
      - clawhuddle-net
    restart: unless-stopped

  gateway-base:
    build:
      context: ./docker/gateway
    image: clawhuddle-gateway:local
    command: ["echo", "Gateway image built"]
    entrypoint: []
    networks:
      - clawhuddle-net

networks:
  clawhuddle-net:
    name: clawhuddle-net
